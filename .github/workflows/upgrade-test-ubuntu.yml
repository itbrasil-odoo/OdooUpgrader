name: OdooUpgrade Integration (Deterministic Fixtures)

on:
  workflow_dispatch:
    inputs:
      run_full_upgrade:
        description: Run full 14.0 -> 15.0 upgrade scenario using base-db fixture
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
  schedule:
    - cron: "0 3 * * 1"

jobs:
  integration-test:
    name: ${{ matrix.scenario.format }} + addons=${{ matrix.scenario.extra_addons }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]
        scenario:
          - { format: "zip", extra_addons: "none" }
          - { format: "dump", extra_addons: "zip" }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Generate deterministic fixtures
        id: fixtures
        run: |
          set -euo pipefail
          ./scripts/fixtures/generate_fixture.sh "$(pwd)/.fixtures" minimal > fixture.env
          cat fixture.env
          while IFS='=' read -r key value; do
            echo "$key=$value" >> "$GITHUB_OUTPUT"
          done < fixture.env

      - name: Run deterministic integration scenario
        run: |
          set -euo pipefail

          if [ "${{ matrix.scenario.format }}" = "zip" ]; then
            SOURCE="${{ steps.fixtures.outputs.source_zip }}"
          else
            SOURCE="${{ steps.fixtures.outputs.source_dump }}"
          fi

          CMD=(odooupgrader --source "$SOURCE" --version "15.0" --dry-run --verbose)

          if [ "${{ matrix.scenario.extra_addons }}" = "zip" ]; then
            CMD+=(--extra-addons "${{ steps.fixtures.outputs.extra_addons_zip }}")
          fi

          "${CMD[@]}"

      - name: Print output artifacts
        if: always()
        run: |
          ls -lah output/ || true

  integration-full-upgrade:
    name: Full upgrade (base-db profile)
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.run_full_upgrade == 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Generate base-db fixture
        id: fixtures
        run: |
          set -euo pipefail
          ./scripts/fixtures/generate_fixture.sh "$(pwd)/.fixtures" base-db > fixture.env
          cat fixture.env
          while IFS='=' read -r key value; do
            echo "$key=$value" >> "$GITHUB_OUTPUT"
          done < fixture.env

      - name: Run full 14.0 -> 15.0 upgrade
        run: |
          set -euo pipefail
          odooupgrader \
            --source "${{ steps.fixtures.outputs.source_zip }}" \
            --version "15.0" \
            --resume \
            --state-file "output/ci-full-upgrade-state.json" \
            --retry-count 0 \
            --step-timeout-minutes 20
          test -f output/upgraded.zip

      - name: Validate resume guard after successful run
        run: |
          set -euo pipefail
          if odooupgrader \
            --source "${{ steps.fixtures.outputs.source_zip }}" \
            --version "15.0" \
            --resume \
            --state-file "output/ci-full-upgrade-state.json"; then
            echo "Expected resume on successful state file to fail."
            exit 1
          fi

      - name: Print output artifacts
        if: always()
        run: |
          ls -lah output/ || true
          tail -n 200 output/odoo.log || true
