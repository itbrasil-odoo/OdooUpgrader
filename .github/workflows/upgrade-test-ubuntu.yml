name: OdooUpgrade Integration (Deterministic Fixtures)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"

jobs:
  integration-test:
    name: ${{ matrix.scenario.format }} + addons=${{ matrix.scenario.extra_addons }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11"]
        scenario:
          - { format: "zip", extra_addons: "none" }
          - { format: "dump", extra_addons: "zip" }

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          pip install .

      - name: Generate deterministic fixtures
        id: fixtures
        run: |
          set -euo pipefail
          ./scripts/fixtures/generate_fixture.sh "$(pwd)/.fixtures" > fixture.env
          cat fixture.env
          while IFS='=' read -r key value; do
            echo "$key=$value" >> "$GITHUB_OUTPUT"
          done < fixture.env

      - name: Run deterministic integration scenario
        run: |
          set -euo pipefail

          if [ "${{ matrix.scenario.format }}" = "zip" ]; then
            SOURCE="${{ steps.fixtures.outputs.source_zip }}"
          else
            SOURCE="${{ steps.fixtures.outputs.source_dump }}"
          fi

          CMD=(odooupgrader --source "$SOURCE" --version "15.0" --dry-run --verbose)

          if [ "${{ matrix.scenario.extra_addons }}" = "zip" ]; then
            CMD+=(--extra-addons "${{ steps.fixtures.outputs.extra_addons_zip }}")
          fi

          "${CMD[@]}"

      - name: Print output artifacts
        if: always()
        run: |
          ls -lah output/ || true
